<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Cámara de Atrás</title>
    </head>
    <body>
        <h1>Cámara de Atrás</h1>
        <button id="open-camera-btn">Abrir Cámara</button>
        <button id="capture-btn" style="display: none">Tomar Foto</button>
        <div id="image-container"></div>

        <script>
            document
                .getElementById("open-camera-btn")
                .addEventListener("click", function () {
                    if (!("mediaDevices" in navigator)) {
                        alert("Este navegador no soporta acceso a la cámara.");
                        return;
                    }

                    // Intentar obtener el stream de la cámara trasera
                    navigator.mediaDevices
                        .getUserMedia({ video: { facingMode: { exact: "environment" } } })
                        .then(function (stream) {
                            // Ocultar el botón de abrir cámara y mostrar el botón de captura
                            document.getElementById("open-camera-btn").style.display =
                                "none";
                            document.getElementById("capture-btn").style.display =
                                "block";

                            // Crear un elemento de video para mostrar la vista previa de la cámara
                            var videoElement = document.createElement("video");
                            videoElement.setAttribute("autoplay", "");
                            videoElement.srcObject = stream;
                            videoElement.width = 250; // Establecer el ancho del elemento de vídeo
                            videoElement.height = 250; // Establecer la altura del elemento de vídeo
                            document.body.appendChild(videoElement);

                            // Crear un canvas para capturar la imagen
                            var canvasElement = document.createElement("canvas");
                            canvasElement.width = 250; // Establecer el ancho del canvas
                            canvasElement.height = 250; // Establecer la altura del canvas
                            var context = canvasElement.getContext("2d");

                            // Esperar un momento para que el video se cargue correctamente
                            videoElement.onloadedmetadata = function () {
                                // Al hacer clic en el botón de captura, capturar la imagen del video
                                document
                                    .getElementById("capture-btn")
                                    .addEventListener("click", function () {
                                        // Capturar solo el área deseada del elemento de vídeo
                                        var sx = (videoElement.videoWidth - 250) / 2;
                                        var sy = (videoElement.videoHeight - 250) / 2;
                                        context.drawImage(
                                            videoElement,
                                            sx,
                                            sy,
                                            250,
                                            250,
                                            0,
                                            0,
                                            250,
                                            250
                                        );
                                        // Convertir la imagen del canvas a base64 y mostrarla en un elemento de imagen
                                        var imgData =
                                            canvasElement.toDataURL("image/png");
                                        var imgElement = document.createElement("img");
                                        imgElement.src = imgData;
                                        document
                                            .getElementById("image-container")
                                            .appendChild(imgElement);
                                        // Detener la reproducción del video y liberar los recursos
                                        stream
                                            .getTracks()
                                            .forEach((track) => track.stop());
                                        videoElement.remove();
                                    });
                            };
                        })
                        .catch(function (error) {
                            console.error("Error al acceder a la cámara:", error);
                            alert(
                                "No se puede acceder a la cámara. Por favor, asegúrate de dar permisos para acceder a la cámara o de que el dispositivo tenga una cámara trasera."
                            );
                        });
                });
        </script>
    </body>
</html>
