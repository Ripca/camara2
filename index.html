<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Página de Ejemplo</title>
        <style>
            #modalContainer {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 1000;
            }

            #modalContent {
                display: flex;
                justify-content: center;
                align-items: center;
                width: 100%;
                height: 100%;
            }

            .caja {
                position: relative;
                display: flex;
                flex-direction: column;
                border: dashed 3px red;
                margin: 10px;
                width: 284.409px; /* Ancho fijo de la caja */
                height: 163.228px; /* Alto fijo de la caja */
            }

            .nombre-caja {
                position: absolute;
                top: -20px;
                left: 0;
                right: 0;
                text-align: center;
            }

            .caja img {
                width: 100%;
                height: 100%;
            }
        </style>
    </head>
    <body>
        <div id="modalContainer">
            <div id="modalContent">
                <!-- La cámara se agregará aquí dinámicamente -->
                <video id="video" style="max-width: 100%; max-height: 100%"></video>
                <div style="margin: 30px">
                    <button id="tomar-foto-btn" onclick="tomarFoto()">Tomar Foto</button>
                </div>
            </div>
        </div>

        <div
            class="form-group-sm col-md-12"
            style="display: flex; justify-content: space-around; flex-wrap: wrap"
        >
            <div onclick="abrirModal('imagenCaja1')" id="caja1" class="caja">
                <span class="nombre-caja">DPI reverso</span>
                <img id="imagenCaja1" src="card.svg" alt="DPI reverso" />
            </div>
            <div onclick="abrirModal('imagenCaja2')" id="caja2" class="caja">
                <span class="nombre-caja">DPI reverso</span>
                <img id="imagenCaja2" src="card.svg" alt="DPI reverso" />
            </div>
        </div>

        <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
        <script>
            let currentBoxId; // Almacena el ID de la caja actual
            let scanner; // Variable para almacenar el scanner Instascan

            async function abrirModal(boxId) {
                const modal = document.getElementById("modalContainer");
                modal.style.display = "block";

                scanner = new Instascan.Scanner({
                    video: document.getElementById("video"),
                    mirror: false, // Deshabilitar el espejo para usar la cámara trasera
                });
                scanner.addListener("scan", function (content) {
                    alert("Escaneado: " + content);
                });
                Instascan.Camera.getCameras()
                    .then((cameras) => {
                        if (cameras.length > 0) {
                            // Obtener la cámara trasera si está disponible
                            const rearCamera = cameras.find((camera) =>
                                camera.name.toLowerCase().includes("back")
                            );
                            scanner.start(rearCamera || cameras[0]);
                        } else {
                            console.error("No hay cámaras disponibles.");
                        }
                    })
                    .catch((err) => {
                        console.error(err);
                    });

                currentBoxId = boxId; // Guarda el ID de la caja actual
            }

            async function tomarFoto() {
                if (scanner) {
                    scanner.stop();
                }

                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");

                const video = document.getElementById("video");
                const caja = document.getElementById(currentBoxId);
                const width = caja.offsetWidth;
                const height = caja.offsetHeight;

                canvas.width = width;
                canvas.height = height;

                // Calcular las dimensiones de la imagen a capturar
                const aspectRatio = video.videoWidth / video.videoHeight;
                const targetWidth = Math.min(width, video.videoWidth);
                const targetHeight = targetWidth / aspectRatio;

                // Calcular la posición de inicio en el video para recortar
                const startX = (video.videoWidth - targetWidth) / 2;
                const startY = (video.videoHeight - targetHeight) / 2;

                // Dibujar la porción del video en el canvas
                ctx.drawImage(
                    video,
                    startX,
                    startY,
                    targetWidth,
                    targetHeight,
                    0,
                    0,
                    width,
                    height
                );
                const dataURL = canvas.toDataURL("image/jpeg");

                const imagenCaja = document.getElementById(currentBoxId);
                imagenCaja.src = dataURL;

                const modal = document.getElementById("modalContainer");
                modal.style.display = "none";
            }
        </script>
    </body>
</html>
