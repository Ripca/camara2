<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Página de Ejemplo</title>
        <style>
            #modalContainer {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 1000;
            }

            #modalContent {
                display: flex;
                justify-content: center;
                align-items: center;
                width: 100%;
                height: 100%;
            }

            #camaraContainer {
                position: relative;
                overflow: hidden;
                width: 284.409px; /* Ancho fijo de la caja */
                height: 163.228px; /* Alto fijo de la caja */
            }

            #camara {
                width: 100%;
                height: 100%;
                object-fit: cover; /* Ajusta el tamaño del video para llenar el contenedor sin distorsión */
            }

            .caja {
                position: relative;
                display: flex;
                flex-direction: column;
                border: dashed 3px red;
                margin: 10px;
                width: 284.409px; /* Ancho fijo de la caja */
                height: 163.228px; /* Alto fijo de la caja */
            }

            .nombre-caja {
                position: absolute;
                top: -20px;
                left: 0;
                right: 0;
                text-align: center;
            }

            .caja img {
                width: 100%;
                height: 100%;
            }
        </style>
    </head>
    <body>
        <div id="modalContainer">
            <div id="modalContent" style="display: flex; flex-direction: column">
                <div id="camaraContainer">
                    <video id="camara" autoplay></video>
                </div>
                <div style="margin: 30px">
                    <button id="tomar-foto-btn" onclick="tomarFoto()">Tomar Foto</button>
                </div>
            </div>
        </div>

        <div
            class="form-group-sm col-md-12"
            style="display: flex; justify-content: space-around; flex-wrap: wrap"
        >
            <div onclick="abrirModal('imagenCaja1')" id="caja1" class="caja">
                <span class="nombre-caja">DPI reverso</span>
                <img id="imagenCaja1" src="card.svg" alt="DPI reverso" />
            </div>
            <div onclick="abrirModal('imagenCaja2')" id="caja2" class="caja">
                <span class="nombre-caja">DPI reverso</span>
                <img id="imagenCaja2" src="card.svg" alt="DPI reverso" />
            </div>
        </div>

        <script>
            let currentBoxId; // Almacena el ID de la caja actual

            async function abrirModal(boxId) {
                const modal = document.getElementById("modalContainer");
                const isMobile =
                    /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
                        navigator.userAgent
                    );
                currentBoxId = boxId; // Guarda el ID de la caja actual

                modal.style.display = "block";

                const camara = document.getElementById("camara");
                const caja = document.getElementById(boxId); // Obtiene la caja correspondiente al boxId
                const width = caja.offsetWidth;
                const height = caja.offsetHeight;

                try {
                    let constraints = {
                        video: {
                            width: { ideal: width },
                            height: { ideal: height },
                        },
                    };

                    if (isMobile) {
                        constraints.video.facingMode = { exact: "environment" };
                    }

                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    camara.srcObject = stream;

                    camara.onloadedmetadata = function () {
                        // Ajusta el tamaño de la cámara al tamaño de la caja
                        const aspectRatio = camara.videoWidth / camara.videoHeight;
                        if (aspectRatio > 1) {
                            camara.width = width;
                            camara.height = width / aspectRatio;
                        } else {
                            camara.height = height;
                            camara.width = height * aspectRatio;
                        }
                    };
                } catch (error) {
                    console.error("Error al acceder a la cámara:", error);
                }
            }

            async function tomarFoto() {
                const camara = document.getElementById("camara");
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");

                // Obtiene el tamaño de la caja correspondiente al ID almacenado
                const caja = document.getElementById(currentBoxId);
                const width = caja.offsetWidth;
                const height = caja.offsetHeight;

                // Establece el tamaño del canvas para que coincida con el tamaño de la caja
                canvas.width = width;
                canvas.height = height;

                // Calcula las coordenadas de la porción de la imagen dentro del cuadro de la caja
                const aspectRatio = camara.videoWidth / camara.videoHeight;
                let sx, sy, sWidth, sHeight;

                if (aspectRatio > 1) {
                    sWidth = camara.videoHeight * aspectRatio;
                    sHeight = camara.videoHeight;
                    sx = (camara.videoWidth - sWidth) / 2;
                    sy = 0;
                } else {
                    sWidth = camara.videoWidth;
                    sHeight = camara.videoWidth / aspectRatio;
                    sx = 0;
                    sy = (camara.videoHeight - sHeight) / 2;
                }

                ctx.drawImage(camara, sx, sy, sWidth, sHeight, 0, 0, width, height);
                const dataURL = canvas.toDataURL("image/jpeg");

                const imagenCaja = document.getElementById(currentBoxId); // Obtiene el elemento imagen correspondiente al ID almacenado
                imagenCaja.src = dataURL;

                const stream = camara.srcObject;
                const tracks = stream.getTracks();
                tracks.forEach((track) => track.stop());

                const modal = document.getElementById("modalContainer");
                modal.style.display = "none";
            }
        </script>
    </body>
</html>
